name: "gpu-ci"
on: [workflow_dispatch, push, pull_request]
concurrency:
  group: build-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  gpu-ci:
    name: GPU-CI
    runs-on: [runs-on,runner=gpu-nvidia-lightweight]

    strategy:
      max-parallel: 1
      fail-fast: false

    steps:
      - name: checkout git repository
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: free additional space on runner
        run: ./.github/workflows/helpers/free_space_on_runner_gpu.sh

      - name: install nix
        uses: cachix/install-nix-action@v25
        with:
          github_access_token: '${{ secrets.GITHUB_TOKEN }}'

      - uses: cachix/cachix-action@v14
        with:
          name: ff
          skipPush: true
          # authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: setup nix develop shell
        uses: nicknovitski/nix-develop@v1.1.0
        env:
          NIXPKGS_ALLOW_UNFREE: 1
        with:
          arguments: "--accept-flake-config --impure"

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2

      - name: regenerate all dtgen files
        run: |
          proj dtgen --force

      - name: run cmake
        run: |
          proj cmake

      - name: build test binaries
        run: cd build/normal && make -j8 kernels-tests

      - name: run tests
        # run: cd build/normal && ctest --progress --output-on-failure -L "^(kernels-tests)$"
        run: |
          nvidia-smi
          cd build/normal && nixGL -- lib/kernels/test/kernels-tests